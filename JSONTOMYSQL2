import os
import json
import pymysql
import re

#输入文件所在的文件夹
from pandas.io.sql import table_exists

dirPath = 'D:\\test\\'
database="ximenzi"
UUID="123"

def table_exists(con,table_name) :#这个函数用来判断表是否存在
    sql = "show tables;"
    con.execute(sql)
    tables = [con.fetchall()]
    table_list = re.findall('(\'.*?\')',str(tables))
    table_list = [re.sub("'",'',each) for each in table_list]
    if table_name in table_list:
        return 1;#存在返回1
    else:
        return 0;#不存在返回0

key_list = []
get_keys=[]
def get_dict_allkeys(dict_a):
    """
    遍历嵌套字典，获取json返回结果的所有key值
    :param dict_a:
    :return: key_list
    """
    if isinstance(dict_a, dict):  # 使用isinstance检测数据类型
        # 如果为字典类型，则提取key存放到key_list中
        for x in range(len(dict_a)):
            temp_key = list(dict_a.keys())[x]
            temp_value = dict_a[temp_key]
            key_list.append(temp_key)
            get_dict_allkeys(temp_value)  # 自我调用实现无限遍历
    elif isinstance(dict_a, list):
        # 如果为列表类型，则遍历列表里的元素，将字典类型的按照上面的方法提取key
        for k in dict_a:
            if isinstance(k, dict):
                for x in range(len(k)):
                    temp_key = list(k.keys())[x]
                    temp_value = k[temp_key]
                    key_list.append(temp_key)
                    get_dict_allkeys(temp_value) # 自我调用实现无限遍历
    return key_list


# 打开数据库连接
db = pymysql.connect(host="localhost", user="root",password="123456",database="ximenzi",charset='utf8')
# 使用cursor()方法获取操作游标
cursor = db.cursor()


for i,j,k in os.walk(dirPath):
    for m in k:
        filePath=dirPath+m
        fo = open(filePath, "r")
        print(m.split(".")[0])
        tableName=m.split(".")[0]
        cursor.execute('use '+database)

        if (table_exists(cursor, tableName) != 1):
            print("表不存在")
            break
        while True :
            lines = fo.readline()
            if not lines:
                break
            if lines=="\n":
                continue
            #print(lines,end="")
            data = json.loads(lines)#字符串转json
            #print(str(data))
            get_keys.clear()
            get_keys = get_dict_allkeys(data)#从json取出key
            sql=""
            for i in get_keys:
                # 开始创建MySQL表
                sql = """INSERT INTO `"""+tableName+"""`(`create_time`,`UUID`"""
                for i in get_keys:
                    sql += ",`" + str(i) + "`"
                sql += ") VALUES("
                sql += "now(),"+UUID+",";
                for i in get_keys:
                    sql += "\"" + str(data[i]) + "\","
                sql=sql[:-1]
                sql += ")"
            print(sql)
            try:
                # 执行sql语句
                cursor.execute(sql)
                # 提交到数据库执行
                db.commit()
            except:
                # 如果发生错误则回滚
                db.rollback()
                print("failed")


            # 结束创建MySQL表
        # 关闭数据库连接
        db.close()
        print(str(tableName)+"插入成功")
